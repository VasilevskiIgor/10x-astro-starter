---
/**
 * Test page for OpenRouter API diagnostics
 *
 * Usage: Navigate to /test-openrouter in browser
 *
 * Features:
 * - Real-time test execution
 * - Live progress updates
 * - Detailed metrics display
 */
---

<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenRouter API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">OpenRouter API Diagnostics</h1>
        <p class="text-gray-600 mb-6">Test direct communication with OpenRouter to diagnose generation speed</p>

        <div class="mb-6">
          <button
            id="startTest"
            class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Start Test
          </button>
          <span id="status" class="ml-4 text-gray-600"></span>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="hidden mb-6">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <div>
                <p class="font-medium text-blue-900">Testing OpenRouter API...</p>
                <p class="text-sm text-blue-700">Elapsed time: <span id="timer">0.0</span>s</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Test Results</h2>

          <!-- Success Metrics -->
          <div id="successMetrics" class="hidden">
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <p class="text-sm text-green-600 font-medium">Total Time</p>
                <p class="text-2xl font-bold text-green-900" id="totalTime">-</p>
              </div>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-600 font-medium">Tokens Used</p>
                <p class="text-2xl font-bold text-blue-900" id="tokensUsed">-</p>
              </div>
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <p class="text-sm text-purple-600 font-medium">Model</p>
                <p class="text-lg font-bold text-purple-900" id="model">-</p>
              </div>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-600 font-medium">Cost</p>
                <p class="text-2xl font-bold text-yellow-900" id="cost">-</p>
              </div>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
              <h3 class="font-semibold text-gray-900 mb-2">Content Summary</h3>
              <p class="text-sm text-gray-600 mb-2">Days generated: <span id="daysCount" class="font-medium">-</span></p>
              <p class="text-sm text-gray-600">Total activities: <span id="activitiesCount" class="font-medium">-</span></p>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-900 mb-2">Sample Output</h3>
              <pre id="sampleOutput" class="text-xs text-gray-700 overflow-x-auto"></pre>
            </div>
          </div>

          <!-- Error Display -->
          <div id="errorDisplay" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <h3 class="font-semibold text-red-900 mb-2">Error</h3>
              <p class="text-sm text-red-700" id="errorMessage"></p>
              <p class="text-xs text-red-600 mt-2">Time elapsed: <span id="errorTime"></span></p>
            </div>
          </div>

          <!-- Raw Response -->
          <details class="mt-6">
            <summary class="cursor-pointer font-semibold text-gray-700 hover:text-gray-900">Raw Response (JSON)</summary>
            <pre id="rawResponse" class="mt-2 bg-gray-100 p-4 rounded text-xs overflow-x-auto"></pre>
          </details>
        </div>
      </div>
    </div>

    <script>
      let timerInterval;
      let startTime;

      document.getElementById("startTest").addEventListener("click", async () => {
        const button = document.getElementById("startTest");
        const status = document.getElementById("status");
        const progressSection = document.getElementById("progressSection");
        const resultsSection = document.getElementById("resultsSection");
        const successMetrics = document.getElementById("successMetrics");
        const errorDisplay = document.getElementById("errorDisplay");

        // Reset UI
        button.disabled = true;
        status.textContent = "Running test...";
        progressSection.classList.remove("hidden");
        resultsSection.classList.add("hidden");
        successMetrics.classList.add("hidden");
        errorDisplay.classList.add("hidden");

        // Start timer
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          document.getElementById("timer").textContent = elapsed;
        }, 100);

        try {
          console.log("[Test] Calling /api/test-openrouter");

          const response = await fetch("/api/test-openrouter");
          const data = await response.json();

          // Stop timer
          clearInterval(timerInterval);
          progressSection.classList.add("hidden");
          resultsSection.classList.remove("hidden");

          // Display raw response
          document.getElementById("rawResponse").textContent = JSON.stringify(data, null, 2);

          if (data.success) {
            // Show success metrics
            successMetrics.classList.remove("hidden");

            document.getElementById("totalTime").textContent = `${data.metrics.totalTimeSec}s`;
            document.getElementById("tokensUsed").textContent = data.metrics.tokensUsed.toLocaleString();
            document.getElementById("model").textContent = data.metrics.model;
            document.getElementById("cost").textContent = `$${data.metrics.costUsd.toFixed(4)}`;
            document.getElementById("daysCount").textContent = data.summary.daysGenerated;
            document.getElementById("activitiesCount").textContent = data.summary.activitiesCount;
            document.getElementById("sampleOutput").textContent = JSON.stringify(data.contentSample, null, 2);

            status.textContent = `✅ Test completed successfully in ${data.metrics.totalTimeSec}s`;
            status.className = "ml-4 text-green-600 font-medium";
          } else {
            // Show error
            errorDisplay.classList.remove("hidden");
            document.getElementById("errorMessage").textContent = data.error || "Unknown error";
            document.getElementById("errorTime").textContent = `${(data.totalTimeMs / 1000).toFixed(2)}s`;

            status.textContent = "❌ Test failed";
            status.className = "ml-4 text-red-600 font-medium";
          }
        } catch (error) {
          clearInterval(timerInterval);
          progressSection.classList.add("hidden");
          resultsSection.classList.remove("hidden");
          errorDisplay.classList.remove("hidden");

          document.getElementById("errorMessage").textContent = error.message;
          document.getElementById("errorTime").textContent = `${((Date.now() - startTime) / 1000).toFixed(2)}s`;

          status.textContent = "❌ Request failed";
          status.className = "ml-4 text-red-600 font-medium";
        } finally {
          button.disabled = false;
        }
      });
    </script>
  </body>
</html>
